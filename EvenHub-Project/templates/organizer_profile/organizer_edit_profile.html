{% extends "organizer_profile/base_dashboard.html" %}
{% block content %}

<style>
  body {
    background-color: #121212;
  }

  input,
  select,
  textarea {
    background-color: #1e1e1e !important;
    color: #fff !important;
    border: 1px solid #333 !important;
  }

  label {
    color: #ccc;
    font-weight: 500;
  }

  .form-control:focus {
    box-shadow: 0 0 0 0.2rem rgba(255, 193, 7, 0.25);
  }

  .form-section {
    background-color: #1e1e1e;
    padding: 2rem;
    border-radius: 12px;
    box-shadow: 0 0 15px rgba(255, 140, 0, 0.15);
  }

  .alert {
    max-width: 600px;
    margin: 0 auto 20px;
  }

  .form-title {
    text-align: center;
    margin-bottom: 1.5rem;
  }

  .form-title h3 {
    color: #ffc107;
    font-weight: bold;
  }

  .btn-warning {
    font-weight: 600;
    padding: 10px 30px;
    border-radius: 8px;
  }

  input[type="file"] {
    color: white;
    background-color: #1e1e1e;
    border: none;
    width: 100%;
  }

  .profile-pic-preview {
    width: 110px;
    height: 110px;
    object-fit: cover;
    border-radius: 50%;
    border: 3px solid #ffc107;
    margin-bottom: 1rem;
    cursor: pointer;
  }

  /* Cropper modal */
  .modal-crop {
    display: none;
    position: fixed;
    z-index: 1050;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.8);
    justify-content: center;
    align-items: center;
  }

  .modal-crop img {
    max-width: 90%;
    max-height: 80vh;
  }

  .modal-crop.active {
    display: flex;
  }

  .modal-buttons {
    margin-top: 15px;
    text-align: center;
  }
</style>

<!-- Cropper.js CSS -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet"/>

<div class="container py-4 px-3 px-md-5">
  <div class="form-title">
    <h3>üè¢ Edit Organizer Profile</h3>
    <p class="text-light">Update your organization details below</p>
  </div>

  <form method="post" enctype="multipart/form-data" class="form-section mx-auto" style="max-width: 900px;">
    {% csrf_token %}

    <!-- Logo Preview -->
    <div class="text-center">
      {% if organizer.logo %}
      <img src="{{ organizer.logo.url }}" alt="Organization Logo" class="profile-pic-preview" id="logoPreview">
      {% else %}
      <img src="https://via.placeholder.com/110" alt="Organization Logo" class="profile-pic-preview" id="logoPreview">
      {% endif %}
    </div>

    <!-- Logo Input -->
    <div class="mb-4">
      <label class="form-label text-light">Change Organization Logo</label>
      {{ o_form.logo }}
    </div>

    <div class="row g-3">
      <div class="col-md-6">
        <label>Organization Name</label>
        {{ o_form.organization_name }}
      </div>
      <div class="col-md-6">
        <label>Website</label>
        {{ o_form.website }}
      </div>
      <div class="col-md-6">
        <label>Phone Number</label>
        {{ o_form.phone }}
      </div>
      <div class="col-md-6">
        <label>City</label>
        {{ o_form.city }}
      </div>
      <div class="col-md-6">
        <label>State</label>
        {{ o_form.state }}
      </div>
      <div class="col-12">
        <label>Description</label>
        {{ o_form.description }}
      </div>
    </div>

    <hr class="my-4 text-light">

    <h5>Enter Payment Details</h5> <br>

    <!-- Payout Details -->
    <div class="row g-3">
      <div class="col-md-6">
        <label>Bank Name</label>
        {{ o_form.bank_name }}
      </div>

      <div class="col-md-6">
        <label>Bank Account Number</label>
        {{ o_form.bank_account_number }}
      </div>
      <div class="col-md-6">
        <label>Bank IFSC Code</label>
        {{ o_form.bank_ifsc_code }}
      </div>
      <div class="col-md-6">
        <label>UPI ID</label>
        {{ o_form.upi_id }}
      </div>
    </div>

    <!-- Submit -->
    <div class="text-center mt-4">
      <button type="submit" class="btn btn-warning">üíæ Save Changes</button>
    </div>
  </form>
</div>

<!-- Crop Modal -->
<div class="modal-crop" id="cropModal">
  <div>
    <img id="cropImage" src="">
    <div class="modal-buttons">
      <button id="cropBtn" class="btn btn-warning me-2">Crop & Save</button>
      <button id="closeCrop" class="btn btn-secondary">Cancel</button>
    </div>
  </div>
</div>

<!-- Cropper.js JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

<script>
  const logoInput = document.getElementById("id_logo");
  const preview = document.getElementById("logoPreview");
  const cropModal = document.getElementById("cropModal");
  const cropImage = document.getElementById("cropImage");
  const cropBtn = document.getElementById("cropBtn");
  const closeCrop = document.getElementById("closeCrop");

  let cropper;

  // Click on logo preview to trigger file input
  preview.addEventListener("click", () => {
    logoInput.click();
  });

  // Open cropper when a file is chosen
  if (logoInput) {
    logoInput.addEventListener("change", function (event) {
      if (event.target.files && event.target.files[0]) {
        const reader = new FileReader();
        reader.onload = function (e) {
          cropImage.src = e.target.result;
          cropModal.classList.add("active");

          if (cropper) cropper.destroy();
          cropper = new Cropper(cropImage, {
            aspectRatio: 1, // Square crop for logo
            viewMode: 1,
            movable: true,
            zoomable: true,
            rotatable: false,
            scalable: false
          });
        };
        reader.readAsDataURL(event.target.files[0]);
      }
    });
  }

  // Crop and replace preview + file input
  cropBtn.addEventListener("click", () => {
    const canvas = cropper.getCroppedCanvas({
      width: 300,
      height: 300,
    });
    preview.src = canvas.toDataURL("image/png");

    // Replace file input value with cropped blob
    canvas.toBlob((blob) => {
      const file = new File([blob], "logo.png", { type: "image/png" });
      const dataTransfer = new DataTransfer();
      dataTransfer.items.add(file);
      logoInput.files = dataTransfer.files;
    });

    cropModal.classList.remove("active");
  });

  // Cancel cropping
  closeCrop.addEventListener("click", () => {
    cropModal.classList.remove("active");
    if (cropper) cropper.destroy();
  });
</script>

{% endblock %}
