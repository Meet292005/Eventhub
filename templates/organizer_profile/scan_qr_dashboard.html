{% extends "organizer_profile/base_dashboard.html" %}

{% block content %}
<div class="container mt-4 text-center">
    <h3 class="text-warning">üì∑ Scan Ticket QR</h3>
    <p class="text-muted">
        Point your camera at a customer‚Äôs QR ticket. Valid tickets will be marked as attended automatically.
    </p>

    <div id="qr-reader" style="width:100%; max-width:500px; margin:auto; border:2px solid #ffc107; border-radius:10px;"></div>
    <div id="qr-result" class="mt-3 text-success fw-bold"></div>
    <div id="qr-error" class="mt-3 text-danger fw-bold"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/html5-qrcode/minified/html5-qrcode.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
    const resultDiv = document.getElementById("qr-result");
    const errorDiv = document.getElementById("qr-error");

    function onScanSuccess(decodedText, decodedResult) {
        resultDiv.innerText = "‚úÖ QR scanned! Verifying...";
        errorDiv.innerText = "";

        // Redirect to verify_ticket_qr directly (booking_id is in URL)
        window.location.href = decodedText;
    }

    function onScanError(errorMessage) {
        console.warn("QR scan error:", errorMessage);
    }

    try {
        let html5QrcodeScanner = new Html5QrcodeScanner(
            "qr-reader",
            { fps: 10, qrbox: 250 },
            false
        );
        html5QrcodeScanner.render(onScanSuccess, onScanError);
    } catch (err) {
        console.error("Camera initialization failed:", err);
        errorDiv.innerText = "‚ùå Unable to access camera: " + err.message;
    }
});
</script>
{% endblock %}
